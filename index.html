<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wifu Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body class="p-2">
    <div
      id="app-wrapper"
      class="h-full w-full rounded-lg overflow-hidden flex flex-col"
    >
      <div class="flex h-[100vh] overflow-hidden">
        <nav
          class="w-20 h-full bg-black/20 flex flex-col items-center py-4 space-y-8 shrink-0 border-r border-white/10"
        >
          <div style="color: var(--accent-pink)">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"
              ></path>
            </svg>
          </div>
          <div class="flex flex-col space-y-6">
            <button
              data-section="editor"
              class="nav-btn p-3 rounded-lg active"
              title="Editor"
            >
              <i data-feather="edit" class="sidebar-icon"></i>
            </button>
            <button
              data-section="gallery"
              class="nav-btn p-3 rounded-lg"
              title="Gallery"
            >
              <i data-feather="image" class="sidebar-icon"></i>
            </button>
            <button
              data-section="presets"
              class="nav-btn p-3 rounded-lg"
              title="Presets"
            >
              <i data-feather="save" class="sidebar-icon"></i>
            </button>
          </div>
        </nav>

        <div class="flex-1 flex flex-col overflow-hidden p-4 space-y-4">
          <div
            id="editor"
            class="app-section flex flex-col h-full overflow-hidden space-y-4"
          >
            <header
              class="bg-black/20 p-3 shadow-lg flex flex-wrap items-center justify-between gap-3 shrink-0 rounded-lg border border-white/10"
            >
              <button
                id="save-preset-btn"
                class="font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-white"
                style="background-color: var(--accent-green-dark)"
              >
                <i data-feather="save" class="w-4 h-4"></i> Save Preset
              </button>
              <div class="flex items-center gap-4">
                <button
                  id="get-screen-size-btn"
                  class="bg-indigo-600/80 hover:bg-indigo-700/80 text-white text-sm font-bold py-2 px-3 rounded-lg"
                >
                  Screen Size
                </button>
                <div>
                  <input
                    type="number"
                    id="custom-width"
                    placeholder="W"
                    class="bg-zinc-800 border border-zinc-700 text-sm rounded-lg w-20 p-2"
                  />
                  <span class="text-zinc-400 mx-1">x</span>
                  <input
                    type="number"
                    id="custom-height"
                    placeholder="H"
                    class="bg-zinc-800 border border-zinc-700 text-sm rounded-lg w-20 p-2"
                  />
                  <button
                    id="apply-custom-size-btn"
                    class="bg-teal-600/80 hover:bg-teal-700/80 text-white text-sm font-bold py-2 px-3 rounded-lg ml-2"
                  >
                    Apply
                  </button>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button
                  id="apply-overlay-btn"
                  class="font-bold py-2 px-4 rounded-lg text-white"
                  style="background-color: var(--accent-pink)"
                >
                  <span class="hover:opacity-80">Apply Overlay</span>
                </button>
                <button
                  id="remove-overlay-btn"
                  class="bg-red-600/80 hover:bg-red-700/80 text-white font-bold py-2 px-4 rounded-lg"
                >
                  Remove
                </button>
                <button
                  id="minimize-to-tray-btn"
                  class="bg-gray-600/80 hover:bg-gray-700/80 text-white font-bold py-2 px-4 rounded-lg"
                >
                  Tray
                </button>
              </div>
            </header>
            <main
              class="flex-1 flex justify-center items-center overflow-auto min-h-0"
            >
              <div
                id="canvas-container"
                style="width: 1280px; aspect-ratio: 16/9; max-width: 100%"
              ></div>
            </main>
          </div>

          <div
            id="gallery"
            class="app-section hidden h-full flex flex-col space-y-4"
          >
            <header
              class="p-3 flex items-center justify-between shrink-0 rounded-lg border border-white/10 bg-black/20"
            >
              <h2 class="text-lg font-bold">Gallery</h2>
              <button
                id="import-gallery-btn"
                class="font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-white"
                style="background-color: var(--accent-pink-dark)"
              >
                <i data-feather="plus-circle" class="w-5 h-5"></i> Import GIFs
              </button>
            </header>
            <div
              id="gallery-grid"
              class="flex-1 p-2 overflow-y-auto custom-scrollbar flex flex-wrap gap-4 items-start align-start"
            ></div>
          </div>

          <div
            id="presets"
            class="app-section hidden h-full flex flex-col space-y-4"
          >
            <header
              class="p-3 flex items-center justify-between shrink-0 rounded-lg border border-white/10 bg-black/20"
            >
              <h2 class="text-lg font-bold">Layout Presets</h2>
              <button
                id="new-preset-btn"
                class="font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-white"
                style="background-color: var(--accent-pink-dark)"
              >
                <i data-feather="plus-circle" class="w-5 h-5"></i> New Preset
              </button>
            </header>

            <div
              class="bg-black/20 p-3 rounded-lg border border-white/10 flex items-center justify-center gap-6 shrink-0"
            >
              <h3 class="font-bold text-white mr-4">App Settings</h3>
              <label
                class="flex items-center gap-2 text-sm text-zinc-300 cursor-pointer"
              >
                <input
                  type="checkbox"
                  id="start-on-startup-check"
                  class="w-4 h-4 rounded bg-zinc-700 border-zinc-600"
                />
                Start on Startup
              </label>
              <label
                class="flex items-center gap-2 text-sm text-zinc-300 cursor-pointer"
              >
                <input
                  type="checkbox"
                  id="load-last-overlay-check"
                  class="w-4 h-4 rounded bg-zinc-700 border-zinc-600"
                />
                Auto-apply Last Overlay
              </label>
            </div>
            <div
              id="presets-list"
              class="flex-1 p-2 overflow-y-auto custom-scrollbar space-y-4"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
    <div
      id="save-preset-modal"
      class="fixed inset-0 z-40 items-center justify-center hidden modal-backdrop"
    >
      <div
        class="bg-zinc-800 rounded-lg shadow-xl p-6 w-full max-w-md border border-zinc-700"
      >
        <h3 class="text-lg font-bold mb-4">Save Preset</h3>
        <div class="space-y-4">
          <div>
            <label
              for="preset-name"
              class="block text-sm font-medium text-zinc-300"
              >Preset Name</label
            >
            <input
              type="text"
              id="preset-name"
              class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500"
            />
          </div>
          <div>
            <label
              for="preset-description"
              class="block text-sm font-medium text-zinc-300"
              >Description</label
            >
            <textarea
              id="preset-description"
              rows="3"
              class="mt-1 block w-full bg-zinc-700 border border-zinc-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500"
            ></textarea>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button
            id="cancel-save-preset-btn"
            class="px-4 py-2 bg-zinc-600 hover:bg-zinc-700 text-white font-semibold rounded-lg"
          >
            Cancel
          </button>
          <button
            id="confirm-save-preset-btn"
            class="px-4 py-2 text-white font-semibold rounded-lg"
            style="background-color: var(--accent-pink)"
          >
            <span class="hover:opacity-80">Save</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      feather.replace();
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let appData = { gallery: [], presets: [], settings: {} }; // Modified
        let activeItem = null;
        let currentAction = null;
        let initialX, initialY, initialWidth, offsetX, offsetY, initialRotation;
        let currentPresetId = null;

        const canvasContainer = document.getElementById("canvas-container");
        const toast = document.getElementById("toast");
        const sections = {
          editor: document.getElementById("editor"),
          gallery: document.getElementById("gallery"),
          presets: document.getElementById("presets"),
        };
        const navButtons = document.querySelectorAll(".nav-btn");
        const getScreenSizeBtn = document.getElementById("get-screen-size-btn");
        const customWidthInput = document.getElementById("custom-width");
        const customHeightInput = document.getElementById("custom-height");
        const applyCustomSizeBtn = document.getElementById(
          "apply-custom-size-btn"
        );
        const applyOverlayBtn = document.getElementById("apply-overlay-btn");
        const removeOverlayBtn = document.getElementById("remove-overlay-btn");
        const minimizeToTrayBtn = document.getElementById(
          "minimize-to-tray-btn"
        );
        const savePresetBtn = document.getElementById("save-preset-btn");
        const importGalleryBtn = document.getElementById("import-gallery-btn");
        const galleryGrid = document.getElementById("gallery-grid");
        const newPresetBtn = document.getElementById("new-preset-btn");
        const presetsList = document.getElementById("presets-list");
        const savePresetModal = document.getElementById("save-preset-modal");
        const presetNameInput = document.getElementById("preset-name");
        const presetDescInput = document.getElementById("preset-description");
        const cancelSavePresetBtn = document.getElementById(
          "cancel-save-preset-btn"
        );
        const confirmSavePresetBtn = document.getElementById(
          "confirm-save-preset-btn"
        );

        // --- NEW: Settings Checkboxes (Feature 1) ---
        const startOnStartupCheck = document.getElementById(
          "start-on-startup-check"
        );
        const loadLastOverlayCheck = document.getElementById(
          "load-last-overlay-check"
        );

        // --- MODIFIED: initialize (Feature 1) ---
        async function initialize() {
          if (window.electronAPI) {
            appData = await window.electronAPI.loadData();
            // Load settings into checkboxes
            if (appData.settings) {
              startOnStartupCheck.checked = !!appData.settings.startOnStartup;
              loadLastOverlayCheck.checked = !!appData.settings.loadLastPreset;
            }
            renderGallery();
            renderPresets();
          }
          setCanvasSize(1920, 1080);
        }
        initialize();

        function showToast(message) {
          toast.textContent = message;
          toast.classList.add("show");
          setTimeout(() => toast.classList.remove("show"), 3000);
        }

        navButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const sectionId = button.dataset.section;
            Object.values(sections).forEach((s) => s.classList.add("hidden"));
            sections[sectionId].classList.remove("hidden");
            navButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
          });
        });

        // --- MODIFIED: renderGallery (Feature 2) ---
        // Adds a delete button and a specific "add-to-editor-btn"
        function renderGallery() {
          galleryGrid.innerHTML = "";
          appData.gallery.forEach((item) => {
            const div = document.createElement("div");
            div.className =
              "relative w-40 h-40 aspect-square bg-zinc-800/50 rounded-lg overflow-hidden group border border-transparent hover:border-pink-400 transition-all";
            div.dataset.galleryId = item.id; // Store ID for 'add'

            div.innerHTML = `
              <img src="${item.path}" class="w-40 h-40 object-contain">
              <div class="add-to-editor-btn absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                <p class="text-white font-bold text-sm">Add to Editor</p>
              </div>
              <button data-gallery-id="${item.id}" class="delete-gallery-item-btn absolute top-1 right-1 w-6 h-6 bg-red-600/80 hover:bg-red-700/80 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" title="Delete from gallery" style="font-size: 20px; line-height: 1;">
                &times;
              </button>
            `;

            // Add listener for "Add to Editor"
            div
              .querySelector(".add-to-editor-btn")
              .addEventListener("click", () => {
                createDraggableItem(item.id);
              });

            galleryGrid.appendChild(div);
          });
        }

        // --- NEW: Event Listener for Gallery Deletion (Feature 2 & 2.1) ---
        galleryGrid.addEventListener("click", async (e) => {
          const deleteBtn = e.target.closest(".delete-gallery-item-btn");
          if (deleteBtn) {
            e.stopPropagation(); // Prevent "add to editor" if mis-clicked
            const galleryId = deleteBtn.dataset.galleryId;
            if (
              confirm(
                "Are you sure you want to delete this item?\n\nThis will also remove it from ALL saved presets."
              )
            ) {
              try {
                showToast("Deleting item..."); // Give feedback
                const newData = await window.electronAPI.deleteGalleryItem(
                  galleryId
                );
                if (newData.success === false) throw new Error(newData.error);

                appData = newData; // Update local data
                renderGallery();
                renderPresets();

                // Check if deleted item is on canvas
                const itemsOnCanvas = Array.from(
                  canvasContainer.querySelectorAll(".overlay-item")
                );
                let itemWasRemoved = false;
                itemsOnCanvas.forEach((itemEl) => {
                  if (itemEl.dataset.galleryId === galleryId) {
                    itemEl.remove();
                    itemWasRemoved = true;
                  }
                });

                if (itemWasRemoved)
                  showToast(
                    "Item deleted from gallery, presets, and current canvas."
                  );
                else showToast("Item deleted from gallery and all presets.");
              } catch (error) {
                console.error("Failed to delete item:", error);
                showToast(`Error deleting item: ${error.message}`);
              }
            }
          }
        });

        importGalleryBtn.addEventListener("click", async () => {
          if (!window.electronAPI)
            return showToast("Feature only available in app.");
          const newFiles = await window.electronAPI.importGalleryFiles();
          if (newFiles && newFiles.length > 0) {
            appData.gallery.push(...newFiles);
            // --- MODIFIED: Save only gallery/presets part of data ---
            await window.electronAPI.saveData({
              gallery: appData.gallery,
              presets: appData.presets,
            });
            renderGallery();
            showToast(`Imported ${newFiles.length} new image(s).`);
          }
        });

        function renderPresets() {
          presetsList.innerHTML = "";
          if (appData.presets.length === 0) {
            presetsList.innerHTML = `<p class="text-zinc-500 text-center py-8">No presets saved yet.</p>`;
            return;
          }
          appData.presets.forEach((preset) => {
            const div = document.createElement("div");
            div.className =
              "bg-black/20 p-4 rounded-lg border border-white/10 flex justify-between items-center";
            div.innerHTML = `<div><h4 class="font-bold text-white">${
              preset.name
            }</h4><p class="text-sm text-zinc-400">${
              preset.description || "No description"
            }</p></div><div class="flex gap-2"><button data-preset-id="${
              preset.id
            }" class="load-preset-btn px-3 py-1.5 bg-blue-600/80 hover:bg-blue-700/80 text-white text-sm font-semibold rounded-lg">Load</button><button data-preset-id="${
              preset.id
            }" class="delete-preset-btn px-3 py-1.5 bg-red-600/80 hover:bg-red-700/80 text-white text-sm font-semibold rounded-lg">Delete</button></div>`;
            presetsList.appendChild(div);
          });
        }

        presetsList.addEventListener("click", async (e) => {
          const presetId = e.target.dataset.presetId;
          if (e.target.classList.contains("load-preset-btn")) {
            const preset = appData.presets.find((p) => p.id === presetId);
            if (preset) {
              loadPreset(preset);
              showToast(`Loaded preset: ${preset.name}`);
              document.querySelector('.nav-btn[data-section="editor"]').click();
            }
          } else if (e.target.classList.contains("delete-preset-btn")) {
            appData.presets = appData.presets.filter((p) => p.id !== presetId);
            // --- MODIFIED: Save only gallery/presets part of data ---
            await window.electronAPI.saveData({
              gallery: appData.gallery,
              presets: appData.presets,
            });
            renderPresets();
            showToast("Preset deleted.");
          }
        });

        newPresetBtn.addEventListener("click", () => {
          clearCanvas();
          currentPresetId = null;
          document.querySelector('.nav-btn[data-section="editor"]').click();
          showToast("Started a new preset.");
        });

        function loadPreset(preset) {
          clearCanvas();
          currentPresetId = preset.id;
          preset.items.forEach((item) => {
            const galleryItem = appData.gallery.find(
              (g) => g.id === item.galleryId
            );
            if (galleryItem) {
              const el = createDraggableItem(item.galleryId, false);
              el.style.left = `${item.left}%`;
              el.style.top = `${item.top}%`;
              el.style.width = `${item.width}px`;
              el.style.height = `${item.height}px`;
              const rotation = item.rotation || 0;
              el.dataset.rotation = rotation;
              el.style.transform = `rotate(${rotation}deg)`;
            }
          });
        }

        savePresetBtn.addEventListener("click", () => {
          const items = Array.from(
            canvasContainer.querySelectorAll(".overlay-item")
          );
          if (items.length === 0)
            return showToast("Cannot save an empty preset.");
          const existingPreset = currentPresetId
            ? appData.presets.find((p) => p.id === currentPresetId)
            : null;
          if (existingPreset) {
            saveOrUpdatePreset(currentPresetId);
          } else {
            presetNameInput.value = "";
            presetDescInput.value = "";
            savePresetModal.classList.remove("hidden");
            savePresetModal.classList.add("flex");
          }
        });

        cancelSavePresetBtn.addEventListener("click", () => {
          savePresetModal.classList.add("hidden");
          savePresetModal.classList.remove("flex");
        });

        confirmSavePresetBtn.addEventListener("click", () =>
          saveOrUpdatePreset()
        );

        async function saveOrUpdatePreset(idToUpdate = null) {
          const canvasRect = canvasContainer.getBoundingClientRect();
          const itemsToSave = Array.from(
            canvasContainer.querySelectorAll(".overlay-item")
          ).map((item) => ({
            galleryId: item.dataset.galleryId,
            left: (item.offsetLeft / canvasRect.width) * 100,
            top: (item.offsetTop / canvasRect.height) * 100,
            width: item.offsetWidth,
            height: item.offsetHeight,
            rotation: parseFloat(item.dataset.rotation) || 0,
          }));

          if (idToUpdate) {
            const presetIndex = appData.presets.findIndex(
              (p) => p.id === idToUpdate
            );
            if (presetIndex > -1) {
              appData.presets[presetIndex].items = itemsToSave;
              showToast(
                `Preset '${appData.presets[presetIndex].name}' updated.`
              );
            }
          } else {
            const name = presetNameInput.value.trim();
            if (!name) return showToast("Preset name is required.");
            const newPreset = {
              id: `preset_${Date.now()}`,
              name,
              description: presetDescInput.value.trim(),
              items: itemsToSave,
            };
            appData.presets.push(newPreset);
            currentPresetId = newPreset.id;
            showToast(`Preset '${name}' saved.`);
          }

          // --- MODIFIED: Save only gallery/presets part of data ---
          await window.electronAPI.saveData({
            gallery: appData.gallery,
            presets: appData.presets,
          });
          renderPresets();
          savePresetModal.classList.add("hidden");
          savePresetModal.classList.remove("flex");
        }

        function setCanvasSize(width, height) {
          if (!width || !height) return showToast("Invalid resolution.");
          canvasContainer.style.aspectRatio = `${width} / ${height}`;
          canvasContainer.style.backgroundImage = `url('https://placehold.co/${width}x${height}/000000/a1a1aa?text=Editor+Canvas+${width}x${height}')`;
          showToast(`Canvas size: ${width}x${height}.`);
        }

        function clearCanvas() {
          canvasContainer.innerHTML = "";
        }

        function createDraggableItem(galleryId, showCreationToast = true) {
          const galleryItem = appData.gallery.find((g) => g.id === galleryId);
          if (!galleryItem) {
            showToast("Error: This gallery item no longer exists.");
            return null;
          }

          const itemWrapper = document.createElement("div");
          itemWrapper.className = "overlay-item";
          itemWrapper.dataset.galleryId = galleryId;
          itemWrapper.dataset.rotation = "0";
          itemWrapper.style.top = "20px";
          itemWrapper.style.left = "20px";
          itemWrapper.innerHTML = `<img src="${galleryItem.path}" /><div class="resize-handle"></div><div class="delete-handle">&times;</div><div class="rotate-handle"><i data-feather="refresh-cw"></i></div>`;

          canvasContainer.appendChild(itemWrapper);
          feather.replace({ width: "12", height: "12" }); // Redraw feather icons
          itemWrapper.addEventListener("mousedown", startAction);
          itemWrapper
            .querySelector(".delete-handle")
            .addEventListener("click", (e) => {
              e.stopPropagation();
              itemWrapper.remove();
              showToast("Item removed from canvas.");
            });

          if (showCreationToast) showToast("Added item to the canvas!");
          return itemWrapper;
        }

        function startAction(e) {
          if (e.target.closest(".delete-handle")) return;
          e.stopPropagation();
          if (activeItem && activeItem !== e.currentTarget)
            activeItem.classList.remove("selected");

          activeItem = e.currentTarget;
          activeItem.classList.add("selected");
          initialX = e.clientX;
          initialY = e.clientY;

          const isRotateHandle = e.target.closest(".rotate-handle");

          if (e.target.closest(".resize-handle")) {
            currentAction = "resize";
            initialWidth = activeItem.offsetWidth;
          } else if (isRotateHandle) {
            currentAction = "rotate";
            initialRotation = parseFloat(activeItem.dataset.rotation) || 0;
          } else {
            currentAction = "drag";
            offsetX = e.clientX - activeItem.getBoundingClientRect().left;
            offsetY = e.clientY - activeItem.getBoundingClientRect().top;
          }
          document.addEventListener("mousemove", performAction);
          document.addEventListener("mouseup", endAction);
        }

        function performAction(e) {
          if (!activeItem) return;
          const canvasRect = canvasContainer.getBoundingClientRect();
          if (currentAction === "drag") {
            let x = e.clientX - canvasRect.left - offsetX;
            let y = e.clientY - canvasRect.top - offsetY;
            activeItem.style.left = `${x}px`;
            activeItem.style.top = `${y}px`;
          } else if (currentAction === "resize") {
            const dx = e.clientX - initialX;
            const newWidth = Math.max(20, initialWidth + dx);
            activeItem.style.width = `${newWidth}px`;
            activeItem.style.height = "auto";
          } else if (currentAction === "rotate") {
            const rect = activeItem.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const startAngle =
              Math.atan2(initialY - centerY, initialX - centerX) *
              (180 / Math.PI);
            const currentAngle =
              Math.atan2(e.clientY - centerY, e.clientX - centerX) *
              (180 / Math.PI);
            const deltaAngle = currentAngle - startAngle;
            const newRotation = initialRotation + deltaAngle;
            activeItem.style.transform = `rotate(${newRotation}deg)`;
            activeItem.dataset.rotation = newRotation;
          }
        }

        function endAction() {
          currentAction = null;
          document.removeEventListener("mousemove", performAction);
          document.removeEventListener("mouseup", endAction);
        }

        canvasContainer.addEventListener("mousedown", (e) => {
          if (e.target === canvasContainer && activeItem) {
            activeItem.classList.remove("selected");
            activeItem = null;
          }
        });

        getScreenSizeBtn.addEventListener("click", async () => {
          if (!window.electronAPI)
            return showToast("Feature only available in app.");
          const { width, height } = await window.electronAPI.getScreenSize();
          setCanvasSize(width, height);
          customWidthInput.value = width;
          customHeightInput.value = height;
        });

        applyCustomSizeBtn.addEventListener("click", () => {
          setCanvasSize(
            parseInt(customWidthInput.value),
            parseInt(customHeightInput.value)
          );
        });

        applyOverlayBtn.addEventListener("click", () => {
          if (!window.electronAPI)
            return showToast("Feature only available in app.");
          const canvasRect = canvasContainer.getBoundingClientRect();
          const items = Array.from(
            canvasContainer.querySelectorAll(".overlay-item")
          )
            .map((item) => {
              const galleryItem = appData.gallery.find(
                (g) => g.id === item.dataset.galleryId
              );
              return {
                path: galleryItem ? galleryItem.path : "",
                left: (item.offsetLeft / canvasRect.width) * 100,
                top: (item.offsetTop / canvasRect.height) * 100,
                width: item.offsetWidth,
                height: item.offsetHeight,
                rotation: parseFloat(item.dataset.rotation) || 0,
              };
            })
            .filter((item) => item.path);

          if (items.length === 0) return showToast("Canvas is empty.");

          window.electronAPI.applyOverlay(items);
          showToast("Overlay applied! (Set as last overlay for startup)");
        });

        removeOverlayBtn.addEventListener("click", () => {
          if (window.electronAPI) window.electronAPI.removeOverlay();
          showToast("Overlay removed.");
        });

        minimizeToTrayBtn.addEventListener("click", () => {
          if (window.electronAPI) window.electronAPI.minimizeToTray();
        });

        // --- NEW: Event Listeners for Settings (Feature 1) ---
        async function handleSettingsChange() {
          if (!window.electronAPI) return;
          const newSettings = {
            startOnStartup: startOnStartupCheck.checked,
            loadLastPreset: loadLastOverlayCheck.checked,
          };
          await window.electronAPI.setSettings(newSettings);
          appData.settings = newSettings; // Update local copy
          showToast("Settings saved.");
        }

        startOnStartupCheck.addEventListener("change", handleSettingsChange);
        loadLastOverlayCheck.addEventListener("change", handleSettingsChange);
      });
    </script>
  </body>
</html>
