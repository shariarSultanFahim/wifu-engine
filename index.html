<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Windows 11 Overlay Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #1a1a1a;
        color: #f0f0f0;
      }
      .canvas-container {
        position: relative;
        background-size: cover;
        background-position: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease-in-out;
        overflow: hidden;
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .overlay-item {
        position: absolute;
        cursor: grab;
        user-select: none;
        width: 200px;
        height: auto;
        transition: transform 0.2s ease;
      }
      .overlay-item img {
        width: 100%;
        height: 100%;
        display: block;
        pointer-events: none;
      }
      .overlay-item:active {
        cursor: grabbing;
      }
      .overlay-item.selected {
        outline: 2px dashed #38bdf8; /* sky-400 */
        z-index: 1000;
      }
      .resize-handle,
      .delete-handle {
        position: absolute;
        width: 12px;
        height: 12px;
        background-color: #38bdf8;
        border: 2px solid white;
        border-radius: 50%;
        display: none;
        z-index: 1001;
      }
      .overlay-item.selected .resize-handle,
      .overlay-item.selected .delete-handle {
        display: block;
      }
      .resize-handle.br {
        bottom: -6px;
        right: -6px;
        cursor: nwse-resize;
      }
      .delete-handle {
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        background-color: #ef4444; /* red-500 */
        cursor: pointer;
        z-index: 1002;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: white;
        line-height: 1;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background-color: #2a2a2a;
        color: white;
        border-radius: 9999px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        visibility: hidden;
      }
      .toast.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }
    </style>
  </head>
  <body
    class="bg-zinc-900 flex flex-col items-center justify-center min-h-screen p-4 md:p-8 transition-colors duration-300"
  >
    <div id="app-container" class="w-full max-w-7xl">
      <!-- Header Controls -->
      <header
        class="controls bg-zinc-800/50 backdrop-blur-xl p-4 rounded-xl mb-6 border border-zinc-700 shadow-lg flex flex-wrap items-center justify-between gap-4"
      >
        <h1 class="text-xl font-bold text-white">Overlay Creator</h1>

        <div class="flex flex-wrap items-center gap-4">
          <!-- Canvas Size Controls -->
          <div class="flex items-center gap-4">
            <button
              id="get-screen-size-btn"
              class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-3 rounded-lg"
            >
              Use Screen Size
            </button>
            <div class="flex items-center gap-2">
              <input
                type="number"
                id="custom-width"
                placeholder="Width"
                class="bg-zinc-700 border border-zinc-600 text-white text-sm rounded-lg w-20 p-2.5"
              />
              <span class="text-zinc-400">x</span>
              <input
                type="number"
                id="custom-height"
                placeholder="Height"
                class="bg-zinc-700 border border-zinc-600 text-white text-sm rounded-lg w-20 p-2.5"
              />
              <button
                id="apply-custom-size-btn"
                class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold py-2 px-3 rounded-lg"
              >
                Apply
              </button>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center gap-2">
            <button
              id="add-image-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105"
            >
              Add Image/GIF
            </button>
            <input
              type="file"
              id="image-upload"
              class="hidden"
              accept="image/*"
              multiple
            />

            <button
              id="apply-overlay-btn"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105"
            >
              Apply as Overlay
            </button>
            <button
              id="remove-overlay-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105"
            >
              Remove Overlay
            </button>
            <button
              id="minimize-to-tray-btn"
              class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105"
            >
              Minimize to Tray
            </button>
          </div>
        </div>
      </header>

      <!-- Main Canvas Area -->
      <main class="w-full flex justify-center">
        <div
          id="canvas-container"
          class="canvas-container"
          style="
            background-image: url('https://placehold.co/1920x1080/000000/FFFFFF?text=Windows+Desktop+Background');
            width: 1280px;
            aspect-ratio: 16/9;
            max-width: 100%;
          "
        >
          <!-- Draggable items will be appended here -->
        </div>
      </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Element references
        const getScreenSizeBtn = document.getElementById("get-screen-size-btn");
        const customWidthInput = document.getElementById("custom-width");
        const customHeightInput = document.getElementById("custom-height");
        const applyCustomSizeBtn = document.getElementById(
          "apply-custom-size-btn"
        );
        const addImageBtn = document.getElementById("add-image-btn");
        const imageUpload = document.getElementById("image-upload");
        const applyOverlayBtn = document.getElementById("apply-overlay-btn");
        const removeOverlayBtn = document.getElementById("remove-overlay-btn");
        const minimizeToTrayBtn = document.getElementById(
          "minimize-to-tray-btn"
        );
        const canvasContainer = document.getElementById("canvas-container");
        const toast = document.getElementById("toast");

        let activeItem = null;
        let currentAction = null; // 'drag' or 'resize'
        let initialX, initialY, initialWidth, offsetX, offsetY;

        function showToast(message) {
          toast.textContent = message;
          toast.classList.add("show");
          setTimeout(() => {
            toast.classList.remove("show");
          }, 3000);
        }

        function setCanvasSize(width, height) {
          if (!width || !height || width <= 0 || height <= 0) {
            showToast("Invalid resolution provided.");
            return;
          }
          canvasContainer.style.aspectRatio = `${width} / ${height}`;
          canvasContainer.style.backgroundImage = `url('https://placehold.co/${width}x${height}/1e293b/94a3b8?text=Simulated+Desktop+${width}x${height}')`;
          showToast(`Canvas size set to ${width}x${height}.`);
        }

        setCanvasSize(1920, 1080);

        getScreenSizeBtn.addEventListener("click", async () => {
          if (
            window.electronAPI &&
            typeof window.electronAPI.getScreenSize === "function"
          ) {
            try {
              const { width, height } =
                await window.electronAPI.getScreenSize();
              setCanvasSize(width, height);
              customWidthInput.value = width;
              customHeightInput.value = height;
            } catch (error) {
              showToast("Could not get screen size.");
              console.error("Error getting screen size:", error);
            }
          } else {
            showToast("This feature is only available in the desktop app.");
          }
        });

        applyCustomSizeBtn.addEventListener("click", () => {
          const width = parseInt(customWidthInput.value, 10);
          const height = parseInt(customHeightInput.value, 10);
          setCanvasSize(width, height);
        });

        canvasContainer.addEventListener("mousedown", (e) => {
          if (e.target === canvasContainer) {
            if (activeItem) {
              activeItem.classList.remove("selected");
              activeItem = null;
            }
          }
        });

        addImageBtn.addEventListener("click", () => imageUpload.click());
        imageUpload.addEventListener("change", (event) => {
          if (event.target.files) {
            Array.from(event.target.files).forEach((file) => {
              // FIX 1: Pass the file object to be processed
              createDraggableItem(file);
            });
            event.target.value = null; // Reset file input
          }
        });

        function createDraggableItem(file) {
          // The file object from the input contains the absolute path we need for the main process
          if (!file.path) {
            showToast(
              "Could not get file path. This may not work in a web browser."
            );
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            const itemWrapper = document.createElement("div");
            itemWrapper.className = "overlay-item";
            itemWrapper.style.top = "20px";
            itemWrapper.style.left = "20px";

            // FIX 1: Store the absolute file path on a data attribute
            itemWrapper.dataset.filePath = file.path;

            const img = document.createElement("img");
            img.src = e.target.result; // Use data URL for local preview

            const resizeHandle = document.createElement("div");
            resizeHandle.className = "resize-handle br";

            const deleteHandle = document.createElement("div");
            deleteHandle.className = "delete-handle";
            deleteHandle.innerHTML = "&times;";

            deleteHandle.addEventListener("click", (e) => {
              e.stopPropagation();
              canvasContainer.removeChild(itemWrapper);
              if (activeItem === itemWrapper) {
                activeItem = null;
              }
              showToast("Item deleted.");
            });

            itemWrapper.appendChild(img);
            itemWrapper.appendChild(resizeHandle);
            itemWrapper.appendChild(deleteHandle);
            canvasContainer.appendChild(itemWrapper);

            itemWrapper.addEventListener("mousedown", startAction);
            showToast("Added new item to the canvas!");
          };
          reader.readAsDataURL(file);
        }

        function startAction(e) {
          e.stopPropagation();
          if (e.target.classList.contains("delete-handle")) return;

          if (activeItem && activeItem !== e.currentTarget) {
            activeItem.classList.remove("selected");
          }

          activeItem = e.currentTarget;
          activeItem.classList.add("selected");

          initialX = e.clientX;
          initialY = e.clientY;

          if (e.target.classList.contains("resize-handle")) {
            currentAction = "resize";
            initialWidth = activeItem.offsetWidth;
          } else {
            currentAction = "drag";
            offsetX = e.clientX - activeItem.getBoundingClientRect().left;
            offsetY = e.clientY - activeItem.getBoundingClientRect().top;
          }

          document.addEventListener("mousemove", performAction);
          document.addEventListener("mouseup", endAction);
        }

        function performAction(e) {
          if (!activeItem || !currentAction) return;

          if (currentAction === "drag") {
            const canvasRect = canvasContainer.getBoundingClientRect();
            let x = e.clientX - canvasRect.left - offsetX;
            let y = e.clientY - canvasRect.top - offsetY;

            const visibleMargin = 20;
            x = Math.max(
              -activeItem.offsetWidth + visibleMargin,
              Math.min(x, canvasRect.width - visibleMargin)
            );
            y = Math.max(
              -activeItem.offsetHeight + visibleMargin,
              Math.min(y, canvasRect.height - visibleMargin)
            );

            activeItem.style.left = `${x}px`;
            activeItem.style.top = `${y}px`;
          } else if (currentAction === "resize") {
            const dx = e.clientX - initialX;
            const img = activeItem.querySelector("img");
            if (!img.naturalWidth || !img.naturalHeight) return;

            const aspectRatio = img.naturalWidth / img.naturalHeight;
            const newWidth = initialWidth + dx;
            const newHeight = newWidth / aspectRatio;

            if (newWidth > 20) {
              activeItem.style.width = `${newWidth}px`;
              activeItem.style.height = `${newHeight}px`;
            }
          }
        }

        function endAction() {
          currentAction = null;
          document.removeEventListener("mousemove", performAction);
          document.removeEventListener("mouseup", endAction);
        }

        applyOverlayBtn.addEventListener("click", () => {
          const canvasRect = canvasContainer.getBoundingClientRect();
          const items = Array.from(
            canvasContainer.querySelectorAll(".overlay-item")
          ).map((item) => {
            return {
              // FIX 1: Send the stored file path instead of the base64 src
              path: item.dataset.filePath,
              left: (item.offsetLeft / canvasRect.width) * 100,
              top: (item.offsetTop / canvasRect.height) * 100,
              width: item.offsetWidth,
              height: item.offsetHeight,
            };
          });

          if (items.length === 0) {
            showToast("Canvas is empty. Add some items first!");
            return;
          }

          if (
            window.electronAPI &&
            typeof window.electronAPI.applyOverlay === "function"
          ) {
            window.electronAPI.applyOverlay(items);
            showToast("Overlay applied!");
          } else {
            showToast("Error: This feature requires the desktop app.");
          }
        });

        removeOverlayBtn.addEventListener("click", () => {
          if (
            window.electronAPI &&
            typeof window.electronAPI.removeOverlay === "function"
          ) {
            window.electronAPI.removeOverlay();
            showToast("Overlay removed.");
          } else {
            showToast("Error: This feature requires the desktop app.");
          }
        });

        minimizeToTrayBtn.addEventListener("click", () => {
          if (
            window.electronAPI &&
            typeof window.electronAPI.minimizeToTray === "function"
          ) {
            window.electronAPI.minimizeToTray();
          } else {
            showToast("Error: This feature requires the desktop app.");
          }
        });
      });
    </script>
  </body>
</html>
